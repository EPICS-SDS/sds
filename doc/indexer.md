# Indexer service
The data will be stored in files and indexed by a database to allow for complex searches based on triggering event, time, or PVs.

## Storage
Data is stored in HDF5 files following the NeXus convention. Each file corresponds to a set of PVs from the configuration file and it can contain one or more events. The file structure is as follows:

    file
    - entry (NXEntry). Attributes: SDS collector version, collector name, event name, event type (#)
      - data
        - event_pulseID_0 (NXData). Attributes: timestamp, pulse ID
          - PV_0:
            - pulse_ID_-K: pre-buffer value(s)
            - ...
            - pulse_ID_0: 
            - ...
            - pulse_ID_L: post-buffer value(s)
          - ...
          - PV_N
        - event_pulseID_1 (NXData). Attributes: timestamp, pulse ID
          - PV_0
          - ...
          - PV_N
        - ...

The NeXus files are saved in a distributed network storage.

The filename is generated using the set name defined in the configuration file, followed by a timestamp with the format:
`dataset_name_YYYYmmdd_HHMMSS.h5`
The timestamp should be the time when the file was created.

### Directory tree structure
The data will be organized according to the following directory structure:
- year (YYYY)
  - day (YYYY-mm-dd)
    - files

## Indexer service
Part of the files' metadata is also stored in a database for faster searches, based on elasticsearch.
Elasticsearch will keep 3 indexes, for the collectors, datasets, and a third to keep track of short term data storage.

The collector index will store these fields, plus a unique ID generated by Elasticsearch:

Field|Type|Description
-----|----|---
name        | [text](https://www.elastic.co/guide/en/elasticsearch/reference/current/text.html)       | name of the collector
event_name  | [keyword](https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html) | name of the timing event
event_code  | [integer](https://www.elastic.co/guide/en/elasticsearch/reference/current/number.html)  | code of the timing event
pvs         | [keyword](https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html) | list of PVs

The unique ID is required since the configuration can be updated to add or remove PVs from a dataset.

The dataset index contains theses fields, plus a unique ID generated by Elasticsearch:

Field|Type|Description
-----|----|---
collector_id      | [keyword](https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html) | ID of the collector that created the dataset
trigger_timestamp      | [date](https://www.elastic.co/guide/en/elasticsearch/reference/current/date.html)       | date of the timing event that triggered this dataset
trigger_pulse_id  | [integer](https://www.elastic.co/guide/en/elasticsearch/reference/current/number.html) | pulse ID of the timing event that triggered this dataset
path              | [keyword](https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html) | file path pointing to the file described by this metadata

Finally the third  index contains theses fields, plus a unique ID generated by Elasticsearch:

Field|Type|Description
-----|----|---
id        | [keyword](https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html) | ID of the item to be expired
expire_by | [date](https://www.elastic.co/guide/en/elasticsearch/reference/current/date.html)       | date to expire the item at

## API
The API of the indexer service will have one entrypoint for adding a new dataset definition and one to add data:


- `/collectors` POST operation to create a collector.  
  - Body
    
    Accepts a JSON object with the following fields
    - `name` (required): a string with the name given to the collector. It should be the one defined in the collector configuration file as `name`. It does not need to be unique.
    - `event_name` (required): a string with the event name as defined in the timing system.
    - `event_code` (required): an integer with the event code as defined in the timing system.
    - `pvs` (required): a list of PVs that belong to this dataset.
  - Response
    
    The created (HTTP 201) or existing (HTTP 200) collector

- `/datasets` POST operation to create a dataset:
  - Parameters
    - `ttl` (optional): a duration in seconds after which the dataset should expire, by default they are stored forever. It is up to the collector service to define this time for each event to fulfill the data reduction policy.
  - Body

    Accepts a JSON object with the following fields
    - `collector_id` (required): the ID string of the creating collector (returned by the `/collectors` operation).
    - `trigger_timestamp` (required): an [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601) date string of triggering event.
    - `trigger_pulse_id` (required): an integer pulse ID of the triggering event.
    - `path` (required): a string with the path to the NeXus file with the data, stored in a shared NFS system.
  - Response
    
    The created (HTTP 201) dataset

NOTE: This API is to be used only by the collector services.